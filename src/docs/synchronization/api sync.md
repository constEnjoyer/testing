# Оптимизация API для X10 режима

## 1. Изменения в API завершения матча (`/api/match/x10/complete`)

### 1.1 Оптимизации
- Все операции выполняются в одной транзакции MongoDB
- Атомарное обновление балансов всех игроков
- Запись истории одним запросом
- Улучшенная валидация победителей
- Проверка таймаутов матча

### 1.2 Структура транзакции
```typescript
try {
  session.startTransaction();
  
  1. Проверка матча и его статуса
  2. Валидация победителей
  3. Обновление статуса матча
  4. Обновление балансов игроков
  5. Запись истории
  
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
}
```

### 1.3 Оптимизация обновления балансов
```typescript
const bulkBalanceOps = [
  // Победители получают TONOT
  ...winners.map(winner => ({
    updateOne: {
      filter: { telegramId: winner.telegramId },
      update: { $inc: { 'balance.tonot': winner.prize } }
    }
  })),
  // Проигравшие получают билеты
  ...losers.map(loser => ({
    updateOne: {
      filter: { telegramId: loser.telegramId },
      update: { $inc: { 'balance.tonotChance': 1 } }
    }
  }))
];
```

## 2. Изменения в API создания матча (`/api/match/x10/create`)

### 2.1 Оптимизации
- Мгновенная блокировка билета при входе в очередь
- Расчет примерного времени ожидания
- Оптимизированное создание матча из очереди
- WebSocket уведомления о начале игры

### 2.2 Процесс создания матча
```typescript
1. Проверка баланса и списание билета
2. Добавление в очередь с блокировкой
3. Попытка создания матча
4. Отправка WebSocket уведомления
```

## 3. Изменения в API отмены матча (`/api/match/x10/cancel`)

### 3.1 Оптимизации
- Проверка времени в очереди (>= 1 час)
- Возврат билета только при таймауте
- Транзакционное удаление из очереди

### 3.2 Логика отмены
```typescript
1. Проверка статуса игрока в очереди
2. Проверка времени ожидания
3. Возврат билета при таймауте
4. Удаление из очереди
```

## 4. Модель WaitingPlayerX10

### 4.1 Новые поля
```typescript
{
  joinedAt: Date,       // Время входа в очередь
  ticketLocked: Boolean, // Флаг блокировки билета
  expiresAt: Date       // Время истечения ожидания
}
```

### 4.2 Индексы для оптимизации
```typescript
// Составной индекс для поиска
{ joinedAt: 1, ticketLocked: 1 }
// Индекс для очистки
{ expiresAt: 1 }
```

## 5. Следующие шаги

### 5.1 UI оптимизации
- [ ] Изменить кнопку отмены на кнопку закрытия окна
- [ ] Добавить индикатор времени ожидания
- [ ] Оптимизировать анимации

### 5.2 Мониторинг
- [ ] Добавить логирование транзакций
- [ ] Мониторинг времени ожидания
- [ ] Отслеживание успешности матчей
